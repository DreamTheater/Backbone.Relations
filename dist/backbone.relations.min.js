/*!
 * Backbone.Relations v0.1.0
 * http://dreamtheater.github.com/Backbone.Relations
 *
 * Copyright (c) 2013 Dmytro Nemoga
 * Released under the MIT license
 */
(function(){"use strict";var e=Backbone.Model;Backbone.Model=e.extend({_RelatedModels:Backbone.Collection.extend({initialize:function(){this.on("add",function(e,t,n){this.model.collection.add(e,n)}),this.on("remove",function(e,t,n){this.model.collection.remove(e,n)})}}),constructor:function(){this._relations={},e.apply(this,arguments),this.collection&&(this.constructor.collection=this.collection)},belongsTo:function(e,t){var n=t.foreignKey;return this._createReference(e,{get:function(){var t=this.get(n);return e.collection.get(t)},set:function(e,t){return this.set(n,e.id,t)},build:function(t,n){return new e(t,n)},create:function(t,n){return e.collection.create(t,n)}},t)},hasOne:function(e,t){var n=t.foreignKey;return this._createReference(e,{get:function(){var t=this._makeHash(null,n);return e.collection.where(t)[0]},set:function(e,t){return e.set(n,this.id,t)},build:function(t,i){var r=this._makeHash(t,n);return new e(r,i)},create:function(t,i){var r=this._makeHash(t,n);return e.collection.create(r,i)}},t)},hasMany:function(e,t){var n=t.foreignKey;return this._createReference(e,{get:function(){var t=this._RelatedModels,i=this._makeHash(null,n),r=e.collection.where(i);return new t(r,{model:e})}},t)},toJSON:_.wrap(e.prototype.toJSON,function(e,t){t=t||{};var n=e.call(this,t),i=_.extend({},t,{caller:this});return t.parse&&_.each(this._relations,function(e,r){var o,c=e.Model;t.caller instanceof c||(o=e.reference.get.call(this),n[r]=o.toJSON(i)),delete n[e.options.foreignKey]},this),n}),_createReference:function(e,t,n){var i=_.string.classify(n.as);return t.get&&(this["get"+i]=t.get),t.set&&(this["set"+i]=t.set),t.build&&(this["build"+i]=t.build),t.create&&(this["create"+i]=t.create),this._addRelation(e,t,n)},_addRelation:function(e,t,n){return this._relations[n.as]={Model:e,reference:t,options:n},this},_makeHash:function(e,t){var n=_.clone(e)||{};return n[t]=this.id,n}})})();