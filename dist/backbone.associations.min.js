/*!
 * Backbone.Associations v0.1.0
 * https://github.com/DreamTheater/Backbone.Associations
 *
 * Copyright Â© 2012-2013 Dmytro Nemoga
 * Released under the MIT license.
 */
(function(){"use strict";var e=Backbone.Model;Backbone.Model=e.extend({constructor:function(){this._associations={},e.apply(this,arguments),this.collection&&(this.constructor.collection=this.collection)},belongsTo:function(e,t){var n=t.foreignKey;return this._createReference(e,{get:function(){var t=this.get(n);return e.collection.get(t)},set:function(e,t){return this.set(n,e.id,t)},build:function(t,n){return new e(t,n)},create:function(t,n){return e.collection.create(t,n)}},t)},hasOne:function(e,t){var n=t.foreignKey;return this._createReference(e,{get:function(){var t=this._createHash(null,n);return e.collection.where(t)[0]},set:function(e,t){return e.set(n,this.id,t)},build:function(t,r){var i=this._createHash(t,n);return new e(i,r)},create:function(t,r){var i=this._createHash(t,n);return e.collection.create(i,r)}},t)},hasMany:function(e,t){var n=t.foreignKey;return this._createReference(e,{get:function(){var t=this._createHash(null,n);return e.collection.where(t)}},t)},toJSON:_.wrap(e.prototype.toJSON,function(e,t){t=t||{};var n=e.call(this,t),r=_.extend({},t,{caller:this});return t.associations&&_.each(this._associations,function(e,i){var c,o=e.Model;t.caller instanceof o||(c=e.reference.get.call(this),c=_.isArray(c)?_.map(c,function(e){return e.toJSON(r)}):c.toJSON(r),n[i]=c),delete n[e.options.foreignKey]},this),n}),_createReference:function(e,t,n){var r=_.string.classify(n.as);return t.get&&(this["get"+r]=t.get),t.set&&(this["set"+r]=t.set),t.build&&(this["build"+r]=t.build),t.create&&(this["create"+r]=t.create),this._addAssociation(e,t,n)},_addAssociation:function(e,t,n){return this._associations[n.as]={Model:e,reference:t,options:n},this},_createHash:function(e,t){var n=_.clone(e)||{};return n[t]=this.id,n}})})();